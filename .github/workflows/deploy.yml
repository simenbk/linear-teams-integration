name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm run test:coverage

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/*/dist
            apps/*/host.json
            apps/*/package.json
            packages/*/dist
          retention-days: 1

      - name: Check if deploy should run
        id: check
        run: echo "should_deploy=true" >> $GITHUB_OUTPUT

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.should_deploy == 'true'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      bot_function_app_name: ${{ steps.deploy.outputs.botFunctionAppName }}
      webhooks_function_app_name: ${{ steps.deploy.outputs.webhooksFunctionAppName }}
      processor_function_app_name: ${{ steps.deploy.outputs.processorFunctionAppName }}
      bot_messages_endpoint: ${{ steps.deploy.outputs.botMessagesEndpoint }}
      linear_webhook_endpoint: ${{ steps.deploy.outputs.linearWebhookEndpoint }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep template
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: norwayeast
          template: ./infra/main.sub.bicep
          parameters: >
            environment=${{ github.event.inputs.environment || 'dev' }}
            resourceGroupName=rg-linear-teams-integration
            microsoftAppId=${{ secrets.MICROSOFT_APP_ID }}
            microsoftAppPassword=${{ secrets.MICROSOFT_APP_PASSWORD }}
            linearApiKey=${{ secrets.LINEAR_API_KEY || '' }}
            linearWebhookSecret=${{ secrets.LINEAR_WEBHOOK_SECRET || '' }}
            postgresAdminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }}
          failOnStdErr: false

      - name: Output deployment results
        run: |
          echo "Bot Function App: ${{ steps.deploy.outputs.botFunctionAppName }}"
          echo "Webhooks Function App: ${{ steps.deploy.outputs.webhooksFunctionAppName }}"
          echo "Processor Function App: ${{ steps.deploy.outputs.processorFunctionAppName }}"
          echo "Bot Messages Endpoint: ${{ steps.deploy.outputs.botMessagesEndpoint }}"
          echo "Linear Webhook Endpoint: ${{ steps.deploy.outputs.linearWebhookEndpoint }}"

  deploy-functions:
    name: Deploy Function Apps
    runs-on: ubuntu-latest
    needs: [build, deploy-infrastructure]
    environment: ${{ github.event.inputs.environment || 'dev' }}
    strategy:
      matrix:
        include:
          - app: bot
            function_app_name_output: bot_function_app_name
          - app: webhooks
            function_app_name_output: webhooks_function_app_name
          - app: processor
            function_app_name_output: processor_function_app_name

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Prepare deployment package
        run: |
          cd apps/${{ matrix.app }}
          npm ci --omit=dev
          zip -r ../../${{ matrix.app }}.zip .

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions
        uses: azure/functions-action@v1
        with:
          app-name: ${{ needs.deploy-infrastructure.outputs[matrix.function_app_name_output] }}
          package: './${{ matrix.app }}.zip'

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-functions]
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Test Bot Health Endpoint
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.deploy-infrastructure.outputs.bot_messages_endpoint }}/health" || echo "000")
          if [ "$response" != "200" ]; then
            echo "Bot health check failed with status: $response"
            exit 1
          fi
          echo "Bot health check passed"

      - name: Test Webhooks Health Endpoint
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.deploy-infrastructure.outputs.linear_webhook_endpoint }}/health" || echo "000")
          if [ "$response" != "200" ]; then
            echo "Webhooks health check failed with status: $response"
            exit 1
          fi
          echo "Webhooks health check passed"

      - name: Output Endpoints
        run: |
          echo "=== Deployment Complete ==="
          echo ""
          echo "Configure these endpoints in your services:"
          echo ""
          echo "Bot Framework Registration:"
          echo "  Messaging endpoint: ${{ needs.deploy-infrastructure.outputs.bot_messages_endpoint }}"
          echo ""
          echo "Linear Webhook Settings:"
          echo "  Webhook URL: ${{ needs.deploy-infrastructure.outputs.linear_webhook_endpoint }}"
